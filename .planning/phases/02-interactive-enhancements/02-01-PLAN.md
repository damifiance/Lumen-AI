---
phase: 02-interactive-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useDraggable.ts
  - frontend/src/components/pdf-viewer/NotePopup.tsx
  - frontend/src/components/pdf-viewer/HighlightContainer.tsx
  - frontend/src/components/pdf-viewer/SelectionTip.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag note popups by their header to any position on screen"
    - "User can drag selection tip popup by its header to any position on screen"
    - "Popup position resets when reopened (starts fresh at default position)"
    - "Dragging popups does not interfere with text selection or copying text from popup content"
  artifacts:
    - path: "frontend/src/hooks/useDraggable.ts"
      provides: "Reusable drag hook using pointer events and CSS transform"
      exports: ["useDraggable"]
    - path: "frontend/src/components/pdf-viewer/NotePopup.tsx"
      provides: "Draggable note popup with header drag handle"
      contains: "drag-handle"
    - path: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      provides: "Portal-rendered NotePopup with drag offset applied via CSS transform"
      contains: "useDraggable"
    - path: "frontend/src/components/pdf-viewer/SelectionTip.tsx"
      provides: "Draggable selection tip with header drag handle in both default and expanded modes"
      contains: "drag-handle"
  key_links:
    - from: "frontend/src/hooks/useDraggable.ts"
      to: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      via: "useDraggable hook import"
      pattern: "useDraggable"
    - from: "frontend/src/hooks/useDraggable.ts"
      to: "frontend/src/components/pdf-viewer/SelectionTip.tsx"
      via: "useDraggable hook import"
      pattern: "useDraggable"
    - from: "frontend/src/components/pdf-viewer/NotePopup.tsx"
      to: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      via: "drag-handle className on header div"
      pattern: "drag-handle"
---

<objective>
Make note popups and selection tip popups draggable by their headers so users can reposition them anywhere on screen to unblock paper content.

Purpose: Users currently cannot move popups out of the way when they cover important text in the PDF. Draggable popups let users reposition annotations to see underlying content without closing them.
Output: useDraggable hook + draggable NotePopup + draggable SelectionTip, all using custom pointer events (no react-draggable library -- uses deprecated findDOMNode that breaks in React 19 strict mode per project research).
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/phases/02-interactive-enhancements/02-RESEARCH.md
@frontend/src/hooks/
@frontend/src/components/pdf-viewer/NotePopup.tsx
@frontend/src/components/pdf-viewer/HighlightContainer.tsx
@frontend/src/components/pdf-viewer/SelectionTip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDraggable hook and make NotePopup draggable</name>
  <files>
    frontend/src/hooks/useDraggable.ts
    frontend/src/components/pdf-viewer/NotePopup.tsx
    frontend/src/components/pdf-viewer/HighlightContainer.tsx
  </files>
  <action>
**Create `frontend/src/hooks/useDraggable.ts`** -- a reusable hook for making elements draggable by a handle.

Use custom pointer events + CSS transform approach (NOT react-draggable -- it uses deprecated findDOMNode which breaks in React 19 strict mode, per .planning/research/STACK.md).

Hook API:
```typescript
interface UseDraggableOptions {
  handleSelector?: string; // CSS selector for drag handle, default '.drag-handle'
  onDragStart?: () => void;
  onDragEnd?: () => void;
}

interface UseDraggableReturn {
  containerRef: React.RefObject<HTMLDivElement>;
  offset: { x: number; y: number };
  resetPosition: () => void;
  isDragging: boolean;
}
```

Implementation details:
- Track drag state with `useRef` (NOT useState -- avoids re-renders during drag per .planning/research/STACK.md Zustand pattern)
- Use a single `useState` for the committed offset `{ x: number, y: number }` that updates only on pointerUp
- Use `useRef` for transient drag position during active drag (startX, startY, currentX, currentY)
- During drag, apply CSS transform directly to the container DOM node via `containerRef.current.style.transform` for zero-rerender dragging
- On pointerUp, commit the final offset to state and clear the direct style
- `resetPosition` sets offset back to `{ x: 0, y: 0 }` and clears any inline transform
- Attach pointerdown listener to elements matching `handleSelector` within the container
- On pointerdown on handle: call `setPointerCapture` on the handle element, record start position, set isDragging
- On pointermove (captured): calculate delta from start, apply `translate(deltaX, deltaY)` as inline CSS transform on containerRef
- On pointerup: release pointer capture, commit final delta to offset state, clear inline transform
- Add `touch-action: none` to the handle via JS during drag to prevent scroll interference
- Require 3px minimum movement threshold before initiating drag (prevents accidental drags when clicking buttons in the header)
- Cleanup: remove all event listeners in useEffect cleanup

**Modify `frontend/src/components/pdf-viewer/NotePopup.tsx`**:
- Add a `drag-handle` CSS class to the existing header div (line 147, the `<div className="px-3 pt-3 pb-2 border-b border-gray-100 flex items-center justify-between">`)
- Add Tailwind classes to the header: `select-none cursor-grab active:cursor-grabbing` (only on the drag-handle div, NOT on content areas -- users must be able to select/copy note text)
- Do NOT add useDraggable to NotePopup itself -- the hook goes in HighlightContainer where the portal wrapper div lives (NotePopup is a child component, the drag needs to move the portal container)

**Modify `frontend/src/components/pdf-viewer/HighlightContainer.tsx`**:
- Import `useDraggable` from `../../hooks/useDraggable`
- Call `const { containerRef: dragRef, offset: dragOffset, resetPosition } = useDraggable({ handleSelector: '.drag-handle' });` at component top level
- In the portal-rendered wrapper div (the one with `style={{ position: 'fixed', ... }}`), attach `ref={dragRef}` (replaces or merges with existing ref if any)
- Apply drag offset to the portal wrapper's transform: combine the existing translate transform with the drag offset. Change from:
  ```
  transform: notePopupBelow ? 'translate(-50%, 0)' : 'translate(-50%, -100%)'
  ```
  to:
  ```
  transform: notePopupBelow
    ? `translate(calc(-50% + ${dragOffset.x}px), ${dragOffset.y}px)`
    : `translate(calc(-50% + ${dragOffset.x}px), calc(-100% + ${dragOffset.y}px))`
  ```
- Call `resetPosition()` inside `handleOpenNotes` (before `setNotePopupOpen(true)`) so position resets each time the popup opens
- The arrow caret in NotePopup should be hidden when popup has been dragged (arrow no longer points at highlight). Add a prop `showArrow?: boolean` to NotePopup, default true. In HighlightContainer, pass `showArrow={dragOffset.x === 0 && dragOffset.y === 0}` so the arrow only shows when popup is at its default position.
  </action>
  <verify>
1. Run `npx tsc --noEmit` from frontend/ directory -- no TypeScript errors
2. Verify `frontend/src/hooks/useDraggable.ts` exists and exports useDraggable
3. Verify `frontend/src/components/pdf-viewer/NotePopup.tsx` contains `drag-handle` class on header div
4. Verify `frontend/src/components/pdf-viewer/HighlightContainer.tsx` imports and uses useDraggable, applies dragOffset to transform, calls resetPosition in handleOpenNotes
  </verify>
  <done>
- useDraggable hook exists with pointer event implementation (no react-draggable dependency)
- NotePopup header has drag-handle class with cursor-grab styling
- HighlightContainer uses useDraggable to make portal-rendered NotePopup draggable
- Drag offset applied via CSS transform on portal wrapper
- Position resets when popup reopens (resetPosition called in handleOpenNotes)
- Arrow caret hidden when popup has been dragged away from default position
- Text selection still works in note content areas (drag only on header)
  </done>
</task>

<task type="auto">
  <name>Task 2: Make SelectionTip draggable with position reset on mode change</name>
  <files>
    frontend/src/components/pdf-viewer/SelectionTip.tsx
  </files>
  <action>
**Modify `frontend/src/components/pdf-viewer/SelectionTip.tsx`**:

Import `useDraggable` from `../../hooks/useDraggable`.

Call `const { containerRef, offset, resetPosition, isDragging } = useDraggable({ handleSelector: '.drag-handle' });` at the top of the component.

**Default mode** (color picker + Note + Ask AI buttons, lines 114-146):
- Wrap the existing outer div in the useDraggable pattern: attach `ref={containerRef}` to the outer div
- Add a `drag-handle` div as a new wrapper around the existing content. The entire default mode toolbar should be the drag handle since it has no text to select. Add classes: `drag-handle select-none cursor-grab active:cursor-grabbing`
- Apply the drag offset as inline style on the container div: `style={{ transform: \`translate(${offset.x}px, ${offset.y}px)\` }}`

**Expanded mode** (Ask AI / Add Note textarea, lines 57-112):
- Attach `ref={containerRef}` to the outer div of the expanded mode
- Add `drag-handle` class to the existing header div (the one containing the icon + "Ask AI" / "Add Note" label + X button, lines 61-78)
- Add `select-none cursor-grab active:cursor-grabbing` to that header div
- Apply drag offset: `style={{ transform: \`translate(${offset.x}px, ${offset.y}px)\` }}` on the outer div
- Do NOT apply drag-handle to the textarea or send button area -- user must be able to type and select text there

**Position reset:**
- Call `resetPosition()` inside the `resetMode` function (line 30-33) so when user closes expanded mode back to default, position resets
- Also call `resetPosition()` when `setMode` is called to switch to 'askAI' or 'note' mode, so expanded mode starts at default position
- The SelectionTip's position already resets naturally when the user makes a new text selection (React re-renders the component fresh via the PdfHighlighter's `selectionTip` prop). However, within the same selection session, switching between modes should reset.

**Important constraint:** The PdfHighlighter library controls where SelectionTip renders (positions it near the text selection). Our drag offset is ADDITIVE to the library's positioning. The library likely uses CSS positioning on a parent wrapper. Our `translate()` transform moves the tip relative to wherever the library placed it. This is the correct behavior -- drag provides an offset from the library's calculated position.

**Handle the containerRef across modes:** Since both default and expanded mode return different JSX trees, and React refs can only attach to one element at a time, the `useDraggable` hook should work correctly as long as `containerRef` is attached to whichever div is currently rendered. When mode switches cause a re-render, the ref will reattach to the new outer div.
  </action>
  <verify>
1. Run `npx tsc --noEmit` from frontend/ directory -- no TypeScript errors
2. Verify `frontend/src/components/pdf-viewer/SelectionTip.tsx` imports useDraggable
3. Verify both default mode and expanded mode have drag-handle classes on appropriate elements
4. Verify offset is applied via style transform in both modes
5. Verify resetPosition is called in resetMode and mode switch handlers
  </verify>
  <done>
- SelectionTip default mode (toolbar) is draggable by the entire toolbar area
- SelectionTip expanded mode (Ask AI / Add Note) is draggable by header only
- Textarea and send button remain interactive (not blocked by drag)
- Position resets when switching between modes
- Position resets on new text selection (component remount by library)
- Drag offset is additive to library's positioning (translate transform)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in frontend/ with no errors
2. `npm run build` succeeds in frontend/ with no errors
3. Manual verification: open app, highlight text, see SelectionTip, drag it by the toolbar, verify it moves
4. Manual verification: open a note popup on an existing highlight, drag by header, verify it moves
5. Manual verification: close and reopen note popup, verify it appears at default position (not dragged position)
6. Manual verification: in expanded Ask AI mode, verify textarea is still typeable and text is selectable
7. Manual verification: in note popup, verify existing note text can be selected and copied
</verification>

<success_criteria>
- NotePopup is draggable by its header, position resets on reopen
- SelectionTip is draggable in both default and expanded modes, position resets on mode switch
- No text selection interference in popup content areas
- No new npm dependencies added (custom pointer events implementation)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-interactive-enhancements/02-01-SUMMARY.md`
</output>
