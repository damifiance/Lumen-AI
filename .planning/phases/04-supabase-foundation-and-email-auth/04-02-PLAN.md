---
phase: 04-supabase-foundation-and-email-auth
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/components/auth/LoginModal.tsx
  - frontend/src/components/auth/SignupModal.tsx
  - frontend/src/components/auth/AuthButton.tsx
  - frontend/src/App.tsx
  - frontend/src/main.tsx
autonomous: false

must_haves:
  truths:
    - "User can sign up with email and password via modal"
    - "User can log in with email and password via modal"
    - "User can log out from any screen"
    - "App works fully offline with Ollama (no auth required)"
    - "Auth actions show loading states and friendly error messages"
    - "User session persists across app restarts"
  artifacts:
    - path: "frontend/src/components/auth/LoginModal.tsx"
      provides: "Email/password login form with loading states and error display"
      contains: "signIn"
    - path: "frontend/src/components/auth/SignupModal.tsx"
      provides: "Email/password signup form with confirmation message"
      contains: "signUp"
    - path: "frontend/src/components/auth/AuthButton.tsx"
      provides: "Conditional auth button — shows Sign In when logged out, user menu when logged in"
      contains: "useAuthStore"
    - path: "frontend/src/App.tsx"
      provides: "Auth initialization on mount, auth modals rendered, AuthButton in UI"
      contains: "initialize"
  key_links:
    - from: "frontend/src/components/auth/LoginModal.tsx"
      to: "frontend/src/stores/authStore.ts"
      via: "useAuthStore().signIn"
      pattern: "useAuthStore.*signIn"
    - from: "frontend/src/components/auth/SignupModal.tsx"
      to: "frontend/src/stores/authStore.ts"
      via: "useAuthStore().signUp"
      pattern: "useAuthStore.*signUp"
    - from: "frontend/src/components/auth/AuthButton.tsx"
      to: "frontend/src/stores/authStore.ts"
      via: "useAuthStore() for user state and signOut"
      pattern: "useAuthStore"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/stores/authStore.ts"
      via: "initialize() call in useEffect"
      pattern: "initialize"
---

<objective>
Build auth UI (login/signup modals, auth button with logout) and integrate into the app.

Purpose: Give users the ability to create accounts, sign in, and sign out. The app must remain fully functional without auth (offline-first with Ollama). Auth is optional and additive.

Output: Working login/signup modals, auth button in the top bar, and complete auth flow integrated into the existing app layout.
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-supabase-foundation-and-email-auth/04-RESEARCH.md
@.planning/phases/04-supabase-foundation-and-email-auth/04-01-SUMMARY.md

@frontend/src/App.tsx
@frontend/src/main.tsx
@frontend/src/components/common/OnboardingModal.tsx
@frontend/src/stores/authStore.ts
@frontend/src/electron.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Login and Signup modals</name>
  <files>frontend/src/components/auth/LoginModal.tsx, frontend/src/components/auth/SignupModal.tsx</files>
  <action>
    Create both modals following the EXACT same pattern as `OnboardingModal.tsx`:
    - Module-level `_listener` variable and exported `openLoginModal()` / `openSignupModal()` functions
    - Component registers listener in useEffect, cleans up on unmount
    - Returns null when not visible

    **LoginModal.tsx:**
    - State: `email`, `password`, `error` (strings), visibility from listener
    - Uses `useAuthStore()` for `signIn` and `isLoading`
    - Form with email input (type="email", required), password input (type="password", required, minLength=6)
    - Submit handler: clear error, call `signIn(email, password)`, if error set it, if success close modal
    - Error display: red text above form when error is set
    - Loading state: inputs disabled, button shows "Signing in..." with a spinner
    - "Don't have an account? Sign up" link at bottom that closes LoginModal and calls `openSignupModal()`
    - Backdrop: `fixed inset-0 bg-black/60 backdrop-blur-sm z-[100]` (matching OnboardingModal)
    - Card: white rounded-2xl shadow-2xl, max-w-md centered
    - Close X button in top right corner
    - Inputs styled with Tailwind: rounded-xl border border-gray-200, px-4 py-3, focus:ring-2 focus:ring-accent, text-sm
    - Submit button: accent color, full width, rounded-xl, matching existing button styles

    **SignupModal.tsx:**
    - Same structure as LoginModal but calls `signUp(email, password)`
    - After successful signup, show a "Check your email" confirmation message instead of closing immediately (Supabase requires email confirmation by default)
    - State includes `isSuccess` boolean — when true, show "Check your email to confirm your account" with a mail icon, and a "Back to Login" button
    - "Already have an account? Sign in" link at bottom that closes SignupModal and calls `openLoginModal()`
    - Password field: add a note below it "At least 6 characters"

    **Shared styling approach:**
    - Use Tailwind classes consistent with existing app (gray-50 backgrounds, accent for primary actions, rounded-xl buttons)
    - Use lucide-react icons: `Mail`, `Lock`, `X`, `Loader2` (for spinner), `CheckCircle` (for success)
    - All text colors: gray-700 for headings, gray-500 for body, gray-400 for hints
  </action>
  <verify>
    - `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit` passes
    - Both files export their `openX()` function and component
    - `grep "openLoginModal\|openSignupModal" frontend/src/components/auth/*.tsx` shows exports
  </verify>
  <done>
    - LoginModal renders email/password form, calls signIn, shows loading/error states, has link to signup
    - SignupModal renders email/password form, calls signUp, shows success "check email" message, has link to login
    - Both follow module-level listener pattern from OnboardingModal
    - Both have proper Tailwind styling matching existing app
  </done>
</task>

<task type="auto">
  <name>Task 2: Auth button component and App integration</name>
  <files>frontend/src/components/auth/AuthButton.tsx, frontend/src/App.tsx, frontend/src/main.tsx</files>
  <action>
    **AuthButton.tsx:**
    - Small component that shows different states based on auth:
      - **Not configured** (no VITE_SUPABASE_URL): render nothing (auth features hidden entirely)
      - **Not logged in**: Show "Sign In" button (lucide `LogIn` icon + text) — calls `openLoginModal()` on click
      - **Logged in**: Show user email (truncated if long) + "Sign Out" button (lucide `LogOut` icon)
        - Use a small dropdown or inline layout: user icon (lucide `User`) + email display + sign out button
        - signOut calls `useAuthStore().signOut()`
    - Style: compact, fits in a header/toolbar. Use text-sm, text-gray-500 hover:text-gray-700 for sign in, and for logged-in state show a subtle pill-shaped container with the user icon and email.
    - Check `import.meta.env.VITE_SUPABASE_URL` — if empty string or undefined, return null (no auth UI shown at all, per SEC-05 offline requirement).

    **App.tsx integration:**
    - Import `useAuthStore` from `./stores/authStore`
    - Import `LoginModal` from `./components/auth/LoginModal`
    - Import `SignupModal` from `./components/auth/SignupModal`
    - Import `AuthButton` from `./components/auth/AuthButton`
    - In the App component, add `const { initialize, isInitialized } = useAuthStore();`
    - Add a useEffect that calls `initialize()` on mount (empty dep array) — this loads any persisted session
    - NOTE: Do NOT gate the entire app on `isInitialized`. The app should work immediately for offline users. Auth initialization happens in the background. The AuthButton will show a brief loading state if needed, but the PDF viewer, file browser, and chat should all work immediately.
    - Add `<AuthButton />` in the top-right area of the UI. Place it inside the main content area header, near the TabBar. The best spot is to add a small toolbar row above or beside the TabBar, or position it absolutely in the top-right. Use your judgment — it should be visible but not intrusive. A good approach: add it to the right side of the TabBar component's row, or add a small flex row above the main content with the AuthButton right-aligned.
    - Add `<LoginModal />` and `<SignupModal />` in the modals section at the bottom of the JSX (alongside OnboardingModal, KeyboardShortcuts, AboutModal).

    **main.tsx:**
    - No changes needed — auth initialization happens in App.tsx via useEffect, not in main.tsx.
  </action>
  <verify>
    - `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit` passes
    - `grep "LoginModal\|SignupModal\|AuthButton" frontend/src/App.tsx` confirms all three are imported and rendered
    - `grep "initialize" frontend/src/App.tsx` confirms auth initialization
    - `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npm run build` succeeds (full Vite build)
  </verify>
  <done>
    - AuthButton shows Sign In when logged out, user email + Sign Out when logged in, nothing when Supabase unconfigured
    - App.tsx initializes auth store on mount
    - Login and Signup modals rendered in App.tsx
    - App works fully without auth configured (offline-first)
    - Vite build succeeds with no errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete auth flow</name>
  <what-built>Complete email/password authentication flow: signup, login, session persistence, logout, and offline-first behavior.</what-built>
  <how-to-verify>
    **Prerequisites:** You need a Supabase project with email auth enabled. Create a `.env` file in `frontend/` with your `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`.

    **Test 1 — Offline mode (no .env):**
    1. Remove or empty the `.env` file in frontend/
    2. Run `cd frontend && npm run dev`
    3. Open http://localhost:5173
    4. Verify: No "Sign In" button visible anywhere. App works normally (file browser, PDF viewer, chat).

    **Test 2 — Sign up:**
    1. Add your Supabase env vars to `.env`
    2. Restart dev server
    3. Click "Sign In" button (should now be visible)
    4. Click "Sign up" link in the login modal
    5. Enter email + password (6+ chars), click Sign Up
    6. Verify: Success message shows "Check your email"

    **Test 3 — Sign in:**
    1. Confirm your email in Supabase (or disable email confirmation in dashboard for testing)
    2. Open login modal, enter credentials, click Sign In
    3. Verify: Modal closes, AuthButton now shows your email and Sign Out option

    **Test 4 — Session persistence:**
    1. While logged in, refresh the page (F5)
    2. Verify: Still logged in (AuthButton shows email, not Sign In)

    **Test 5 — Sign out:**
    1. Click Sign Out
    2. Verify: AuthButton reverts to "Sign In"
    3. Refresh page — verify still logged out

    **Test 6 — Error handling:**
    1. Try signing in with wrong password
    2. Verify: "Invalid email or password" error shown (not a raw Supabase error)
    3. Verify: Loading spinner shows while request is in-flight
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- App launches and works without Supabase configured (offline-first)
- With Supabase configured, Sign In button appears
- User can sign up, sign in, and sign out
- Session persists across page refreshes
- Auth errors are translated to friendly messages
- Loading states shown during auth operations
- All TypeScript compiles, Vite build succeeds
</verification>

<success_criteria>
- All 6 phase success criteria met:
  1. User can sign up with email and password
  2. User can log in with email and password
  3. User session persists across app restarts
  4. User can log out from any screen
  5. App works fully offline with Ollama (no auth required)
  6. Auth actions show loading states and friendly error messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-supabase-foundation-and-email-auth/04-02-SUMMARY.md`
</output>
