---
phase: 06-profile-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/migrations/006_create_profiles.sql
  - frontend/src/stores/profileStore.ts
  - frontend/src/hooks/useUsernameAvailability.ts
  - frontend/src/lib/imageResize.ts
autonomous: true

must_haves:
  truths:
    - "Profile store can fetch and cache user profile from Supabase"
    - "Profile store can update profile fields and reflect changes optimistically"
    - "Username availability hook debounces and returns correct availability status"
    - "Image resize utility produces 400x400 JPEG blob from arbitrary image input"
  artifacts:
    - path: "backend/migrations/006_create_profiles.sql"
      provides: "Profiles table, trigger, RLS policies, avatars bucket + storage RLS"
      contains: "CREATE TABLE profiles"
    - path: "frontend/src/stores/profileStore.ts"
      provides: "Zustand store for profile CRUD with optimistic updates"
      exports: ["useProfileStore"]
    - path: "frontend/src/hooks/useUsernameAvailability.ts"
      provides: "Debounced async username uniqueness check"
      exports: ["useUsernameAvailability"]
    - path: "frontend/src/lib/imageResize.ts"
      provides: "Canvas-based image crop and resize utility"
      exports: ["cropAndResize"]
  key_links:
    - from: "frontend/src/stores/profileStore.ts"
      to: "supabase.from('profiles')"
      via: "Supabase client query"
      pattern: "supabase\\.from\\('profiles'\\)"
    - from: "frontend/src/hooks/useUsernameAvailability.ts"
      to: "supabase.from('profiles')"
      via: "Debounced select query"
      pattern: "\\.eq\\('username'"

user_setup:
  - service: supabase
    why: "Database migration must be run in Supabase SQL Editor"
    dashboard_config:
      - task: "Run 006_create_profiles.sql in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> New query -> Paste and run"
      - task: "Create 'avatars' storage bucket (if not created by SQL)"
        location: "Supabase Dashboard -> Storage -> New bucket -> Name: avatars, Private: true"
---

<objective>
Create the profile system foundation: database schema (profiles table, trigger, RLS), frontend profile store, username availability hook, and image resize utility.

Purpose: Establishes the data layer and utilities that all profile UI components depend on. The database trigger auto-creates a profile row when users sign up, the store manages profile state, and utilities handle username validation and image processing.

Output: SQL migration file ready for Supabase, Zustand profile store, username availability hook, image resize utility.
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-profile-system/06-RESEARCH.md
@.planning/phases/04-supabase-foundation-and-email-auth/04-01-SUMMARY.md
@frontend/src/stores/authStore.ts
@frontend/src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration and install frontend dependencies</name>
  <files>
    backend/migrations/006_create_profiles.sql
  </files>
  <action>
Create `backend/migrations/` directory if it doesn't exist. Write `006_create_profiles.sql` containing:

**1. Profiles table:**
```sql
CREATE TABLE IF NOT EXISTS profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT UNIQUE NOT NULL CHECK (username ~ '^[a-z0-9_]{3,30}$'),
  display_name TEXT,
  avatar_url TEXT,
  bio TEXT CHECK (char_length(bio) <= 500),
  institution TEXT CHECK (char_length(institution) <= 100),
  research_interests TEXT[] DEFAULT '{}',
  username_claimed BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

The `username_claimed` boolean distinguishes auto-generated usernames from intentionally claimed ones. This is better than regex-matching `_\d+$` suffix (which could match legitimate usernames like `john_42`).

**2. Index for username lookups:**
```sql
CREATE INDEX idx_profiles_username ON profiles(username);
```

**3. Trigger function** `handle_new_user()`:
- Extract base username from `NEW.raw_user_meta_data->>'preferred_username'` (GitHub), `NEW.raw_user_meta_data->>'user_name'` (Google), or `split_part(NEW.email, '@', 1)` as fallback
- Sanitize: `lower(regexp_replace(base, '[^a-z0-9_]', '_', 'g'))`
- Ensure min length 3 (pad with 'user' prefix if needed)
- Truncate to 26 chars max (leaving room for `_NNN` suffix)
- LOOP to find unique username (append `_1`, `_2`, etc.)
- INSERT into profiles with `username_claimed = false`
- Extract display_name from `NEW.raw_user_meta_data->>'full_name'` or `->>'name'`
- Wrap in EXCEPTION block so trigger failure doesn't block signup

**4. Attach trigger:**
```sql
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION handle_new_user();
```

**5. RLS policies on profiles:**
- Enable RLS on profiles
- SELECT: anyone can read profiles (`USING (true)`)
- UPDATE: users can update own profile (`auth.uid() = id`)
- INSERT: allow own profile insert (`auth.uid() = id`) — for trigger's SECURITY DEFINER

**6. Avatars storage bucket + RLS:**
```sql
INSERT INTO storage.buckets (id, name, public) VALUES ('avatars', 'avatars', false)
ON CONFLICT (id) DO NOTHING;
```
- INSERT policy: users upload to own folder (`auth.uid()::text = (storage.foldername(name))[1]`)
- UPDATE policy: users update own folder
- DELETE policy: users delete own files
- SELECT policy: anyone can view avatars (`bucket_id = 'avatars'`)

**7. Updated_at trigger** for profiles (auto-update `updated_at` on row change).

Then install frontend dependencies:
```bash
cd frontend && npm install react-image-crop react-hook-form zod @hookform/resolvers --legacy-peer-deps
```

Use `--legacy-peer-deps` because of the existing React 19 peer dependency conflict with react-pdf-highlighter-extended (same pattern as Phase 4 Supabase install).
  </action>
  <verify>
- File exists: `backend/migrations/006_create_profiles.sql`
- SQL contains: CREATE TABLE profiles, CREATE TRIGGER, CREATE POLICY (at least 4 policies), INSERT INTO storage.buckets
- `cd frontend && npx tsc --noEmit` passes (no type errors from new deps)
- `cat frontend/package.json | grep react-image-crop` shows dependency installed
  </verify>
  <done>
Migration SQL file is ready for manual execution in Supabase SQL Editor. Frontend dependencies (react-image-crop, react-hook-form, zod, @hookform/resolvers) are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profileStore, useUsernameAvailability hook, and imageResize utility</name>
  <files>
    frontend/src/stores/profileStore.ts
    frontend/src/hooks/useUsernameAvailability.ts
    frontend/src/lib/imageResize.ts
  </files>
  <action>
**profileStore.ts** — Zustand store following existing authStore patterns:

```typescript
interface Profile {
  id: string;
  username: string;
  display_name: string | null;
  avatar_url: string | null;
  bio: string | null;
  institution: string | null;
  research_interests: string[];
  username_claimed: boolean;
  created_at: string;
  updated_at: string;
}
```

State: `profile: Profile | null`, `isLoading: boolean`

Actions:
- `fetchProfile(userId: string)` — SELECT * from profiles WHERE id = userId, single(). Set profile state.
- `updateProfile(updates: Partial<Profile>)` — Optimistic update: set state immediately, then UPDATE profiles SET ...updates, updated_at = now() WHERE id = profile.id. On error, revert state and re-throw.
- `updateAvatar(userId: string, blob: Blob)` — Upload blob to `avatars/${userId}/avatar-${Date.now()}.jpg` in Supabase Storage (upsert: false). If old avatar_url exists, delete old file first. Get public URL. Call updateProfile({ avatar_url }). Return new URL.
- `claimUsername(userId: string, username: string)` — UPDATE profiles SET username, username_claimed = true WHERE id. Update local state.
- `clearProfile()` — Reset profile to null (called on signout).

Import supabase from `../lib/supabase`. Export `useProfileStore`.

IMPORTANT: Never call Supabase API inside onAuthStateChange callback (known deadlock bug — documented in Phase 4). Profile fetching must be triggered separately (e.g., useEffect in App.tsx watching auth user changes).

**useUsernameAvailability.ts** — Custom hook:
- Parameters: `username: string`, `currentUsername?: string` (skip check if same as current), `debounceMs = 300`
- Returns: `{ isChecking: boolean, isAvailable: boolean | null, error: string | null }`
- Skip validation if username doesn't match `^[a-z0-9_]{3,30}$` regex (set isAvailable to null)
- Skip if username equals currentUsername (set isAvailable to true)
- Debounce with setTimeout + cleanup
- Query: `supabase.from('profiles').select('username').eq('username', username).maybeSingle()`
- `data === null` means available

Create `frontend/src/hooks/` directory if it doesn't exist.

**imageResize.ts** — Pure utility function:
```typescript
export async function cropAndResize(
  imageSrc: string,
  crop: { x: number; y: number; width: number; height: number },
  targetSize: number = 400
): Promise<Blob>
```
- Load image from `imageSrc` (data URL) into HTMLImageElement
- Create canvas at `targetSize x targetSize`
- drawImage with crop coordinates (crop values are in natural image pixels)
- Return canvas.toBlob as JPEG quality 0.9
- Throw if canvas.toBlob returns null
  </action>
  <verify>
- `cd frontend && npx tsc --noEmit` passes with no errors
- profileStore exports `useProfileStore` with fetchProfile, updateProfile, updateAvatar, claimUsername, clearProfile
- useUsernameAvailability exports the hook function
- imageResize exports `cropAndResize`
  </verify>
  <done>
Profile store manages profile CRUD with optimistic updates and avatar upload. Username availability hook provides debounced async validation. Image resize utility handles Canvas-based crop and resize to 400x400 JPEG.
  </done>
</task>

</tasks>

<verification>
1. SQL migration file exists at `backend/migrations/006_create_profiles.sql` and contains all required DDL
2. Frontend TypeScript compiles cleanly: `cd frontend && npx tsc --noEmit`
3. All new dependencies in package.json: react-image-crop, react-hook-form, zod, @hookform/resolvers
4. Profile store, username hook, and image utility all export correct interfaces
</verification>

<success_criteria>
- Database migration SQL is ready for manual execution in Supabase
- profileStore provides complete CRUD with optimistic updates and avatar management
- useUsernameAvailability provides debounced validation with availability feedback
- cropAndResize utility handles image crop + resize to JPEG blob
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-profile-system/06-01-SUMMARY.md`
</output>
