---
phase: 06-profile-system
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/components/profile/UsernameClaimModal.tsx
  - frontend/src/components/profile/ProfileEditModal.tsx
  - frontend/src/components/profile/AvatarCropUpload.tsx
  - frontend/src/App.tsx
  - frontend/src/components/chat/ChatMessage.tsx
  - frontend/src/components/auth/AuthButton.tsx
autonomous: false

must_haves:
  truths:
    - "New user sees UsernameClaimModal on first login when username is not yet claimed"
    - "User can type a username and see real-time availability feedback (spinner, green check, red X)"
    - "User can open ProfileEditModal from AuthButton to edit bio, institution, and research interests"
    - "User can select, crop, and upload an avatar image in ProfileEditModal"
    - "Profile changes persist to Supabase and reflect immediately in UI"
    - "User sees their @username in chat messages instead of 'You'"
    - "User sees their avatar in chat messages instead of generic icon"
  artifacts:
    - path: "frontend/src/components/profile/UsernameClaimModal.tsx"
      provides: "Username claim flow with real-time availability check"
      exports: ["UsernameClaimModal", "openUsernameClaimModal"]
    - path: "frontend/src/components/profile/ProfileEditModal.tsx"
      provides: "Full profile editor with React Hook Form + Zod validation"
      exports: ["ProfileEditModal", "openProfileEditModal"]
    - path: "frontend/src/components/profile/AvatarCropUpload.tsx"
      provides: "Image file select, crop with react-image-crop, resize + upload"
      exports: ["AvatarCropUpload"]
    - path: "frontend/src/components/chat/ChatMessage.tsx"
      provides: "Chat messages showing profile username and avatar"
    - path: "frontend/src/components/auth/AuthButton.tsx"
      provides: "Profile edit button for logged-in users"
  key_links:
    - from: "frontend/src/components/profile/UsernameClaimModal.tsx"
      to: "frontend/src/stores/profileStore.ts"
      via: "claimUsername action"
      pattern: "useProfileStore.*claimUsername"
    - from: "frontend/src/components/profile/UsernameClaimModal.tsx"
      to: "frontend/src/hooks/useUsernameAvailability.ts"
      via: "hook import"
      pattern: "useUsernameAvailability"
    - from: "frontend/src/components/profile/AvatarCropUpload.tsx"
      to: "frontend/src/lib/imageResize.ts"
      via: "cropAndResize utility"
      pattern: "cropAndResize"
    - from: "frontend/src/components/profile/AvatarCropUpload.tsx"
      to: "frontend/src/stores/profileStore.ts"
      via: "updateAvatar action"
      pattern: "useProfileStore.*updateAvatar"
    - from: "frontend/src/components/chat/ChatMessage.tsx"
      to: "frontend/src/stores/profileStore.ts"
      via: "profile state for username + avatar"
      pattern: "useProfileStore"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/stores/profileStore.ts"
      via: "fetchProfile on auth state change"
      pattern: "fetchProfile"
---

<objective>
Build all profile UI components (username claim, profile editor, avatar upload) and integrate them into the app — including chat message display of username + avatar.

Purpose: Delivers the complete user-facing profile experience. Users claim a username on first login, edit their profile (bio, institution, interests, avatar), and see their identity reflected in the chat interface.

Output: UsernameClaimModal, ProfileEditModal, AvatarCropUpload components; modified ChatMessage with profile display; App.tsx integration for profile loading and modal rendering.
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-profile-system/06-RESEARCH.md
@.planning/phases/06-profile-system/06-01-SUMMARY.md
@frontend/src/App.tsx
@frontend/src/components/chat/ChatMessage.tsx
@frontend/src/components/auth/AuthButton.tsx
@frontend/src/components/auth/LoginModal.tsx
@frontend/src/stores/authStore.ts
@frontend/src/stores/profileStore.ts
@frontend/src/hooks/useUsernameAvailability.ts
@frontend/src/lib/imageResize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UsernameClaimModal, ProfileEditModal, and AvatarCropUpload</name>
  <files>
    frontend/src/components/profile/UsernameClaimModal.tsx
    frontend/src/components/profile/ProfileEditModal.tsx
    frontend/src/components/profile/AvatarCropUpload.tsx
  </files>
  <action>
Create `frontend/src/components/profile/` directory.

**UsernameClaimModal.tsx:**
- Follow exact module-level listener pattern from LoginModal.tsx:
  - `let _listener: ((open: boolean) => void) | null = null;`
  - `export function openUsernameClaimModal() { _listener?.(true); }`
  - Register listener in useEffect cleanup
- State: `username` (string), `isSubmitting` (boolean)
- Use `useUsernameAvailability(username)` hook for real-time feedback
- Use `useProfileStore` for `claimUsername` action and `profile` state
- UI: Fixed overlay (`fixed inset-0 bg-black/60 backdrop-blur-sm z-[100]`), centered card
- Input: lowercase-only (transform on change), pattern `[a-z0-9_]{3,30}`
- Validation feedback icons (from lucide-react): `Loader2` (spinning, checking), `Check` (green, available), `X` (red, taken)
- Hint text below input: "3-30 characters, lowercase letters, numbers, underscores"
- Submit button: disabled when `!isAvailable || isSubmitting`
- On successful claim: close modal, profile store already updated
- This modal should NOT have a close/dismiss button — username claim is mandatory for first login
- Style: Match LoginModal aesthetic (rounded-2xl, shadow-2xl, accent colors)

**ProfileEditModal.tsx:**
- Same module-level listener pattern: `openProfileEditModal()` export
- Use `react-hook-form` with `zodResolver` for validation
- Zod schema:
  - `display_name`: string, max 50, optional
  - `bio`: string, max 500, optional (show char counter)
  - `institution`: string, max 100, optional
  - `research_interests`: array of strings, max 10 items (handle as comma-separated input for simplicity — no need for react-tag-autocomplete per research recommendation to start with free-form)
- Pre-populate form with current profile data via `defaultValues`
- Include `<AvatarCropUpload />` component at top of form for avatar editing
- Show current avatar preview (or User icon fallback) with "Change" overlay on hover
- Submit: call `profileStore.updateProfile(data)`, close modal on success
- Has close button (X in top-right) — profile editing is optional
- Use `mode: 'onBlur'` for validation (validate when user leaves field)

**AvatarCropUpload.tsx:**
- Props: `currentAvatarUrl?: string`, `onUploadComplete: (url: string) => void`
- Display: circular avatar preview (current or placeholder User icon)
- Click to open hidden file input (`accept="image/*"`)
- File validation: must be image/*, max 5MB
- On file select: read as data URL, show react-image-crop overlay
  - `import ReactCrop, { type Crop } from 'react-image-crop'`
  - `import 'react-image-crop/dist/ReactCrop.css'`
  - Lock aspect ratio to 1:1
  - Provide reasonable default crop (centered, 80% of smaller dimension)
- "Crop & Upload" button: call `cropAndResize(imageSrc, cropPixels, 400)` from imageResize.ts, then `profileStore.updateAvatar(userId, blob)`
- Show upload progress state (Loader2 spinner)
- On success: call onUploadComplete with new URL, reset crop state
  </action>
  <verify>
- `cd frontend && npx tsc --noEmit` passes
- All three files exist in `frontend/src/components/profile/`
- UsernameClaimModal exports `openUsernameClaimModal` function
- ProfileEditModal exports `openProfileEditModal` function
- AvatarCropUpload imports from react-image-crop and imageResize
  </verify>
  <done>
Three profile components created: UsernameClaimModal (mandatory first-login username claim with real-time availability), ProfileEditModal (full profile editor with form validation), AvatarCropUpload (image crop + resize + upload).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate profile into App.tsx, ChatMessage, and AuthButton</name>
  <files>
    frontend/src/App.tsx
    frontend/src/components/chat/ChatMessage.tsx
    frontend/src/components/auth/AuthButton.tsx
  </files>
  <action>
**App.tsx modifications:**
1. Import `UsernameClaimModal` and `ProfileEditModal`
2. Import `useProfileStore`
3. Add useEffect that watches `useAuthStore.user` changes:
   - When user becomes non-null: call `profileStore.fetchProfile(user.id)`
   - When user becomes null: call `profileStore.clearProfile()`
   - IMPORTANT: This must be a separate useEffect from the auth initialize one. Do NOT fetch profile inside onAuthStateChange callback (Supabase deadlock bug).
4. Add useEffect that watches `profileStore.profile`:
   - When profile exists and `username_claimed === false`: call `openUsernameClaimModal()`
   - This auto-opens the username claim modal for new users
5. Render `<UsernameClaimModal />` and `<ProfileEditModal />` in the modals section (after LoginModal/SignupModal)

**ChatMessage.tsx modifications:**
1. Import `useProfileStore`
2. Import `useAuthStore` (for checking if user is logged in)
3. For user messages (`isUser === true`):
   - Get profile from `useProfileStore((s) => s.profile)`
   - Display name: `profile?.username ? `@${profile.username}` : 'You'` (prefix with @ for claimed usernames)
   - Avatar: If `profile?.avatar_url`, render `<img>` with `w-7 h-7 rounded-lg object-cover` classes. Otherwise keep existing `<User>` icon fallback.
4. For assistant messages: no changes (still shows "Lumen" with logo)
5. Keep all existing functionality (markdown rendering, save-as-note button, etc.) exactly as-is

**AuthButton.tsx modifications:**
1. Import `openProfileEditModal` from profile/ProfileEditModal
2. Import `useProfileStore`
3. When user is logged in, add a "Profile" button/link next to the existing user email display
   - Show small avatar thumbnail if available, otherwise User icon
   - On click: `openProfileEditModal()`
   - Text: "@username" or "Edit Profile" — keep it compact for sidebar
4. On sign out: also call `profileStore.clearProfile()` to clean up profile state
  </action>
  <verify>
- `cd frontend && npx tsc --noEmit` passes
- App.tsx imports and renders UsernameClaimModal and ProfileEditModal
- App.tsx has useEffect for profile fetching on auth state change
- ChatMessage.tsx imports useProfileStore and conditionally renders username/avatar
- AuthButton.tsx has profile edit trigger
  </verify>
  <done>
Profile system fully integrated: App.tsx fetches profile on login and opens username claim for new users, ChatMessage displays @username and avatar, AuthButton provides profile edit access.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete profile system</name>
  <files>none (verification only)</files>
  <action>
Human verification of the complete profile system. Prerequisites: SQL migration must be run in Supabase Dashboard SQL Editor first (file: `backend/migrations/006_create_profiles.sql`).

Verify the following flows:

1. **Username claim flow:**
   - Sign up with a new account (or delete existing profile row in Supabase to test)
   - After login, UsernameClaimModal should appear automatically
   - Type a username — verify real-time availability feedback (spinner while checking, green check if available, red X if taken)
   - Try invalid formats (too short, special chars) — should show validation hints
   - Claim a valid username — modal closes
   - Refresh app — modal should NOT reappear (username_claimed = true)

2. **Profile editing:**
   - Click profile button in sidebar (AuthButton area)
   - ProfileEditModal opens with current data pre-filled
   - Edit bio (verify char counter), institution, display name
   - Add research interests (comma-separated)
   - Save — verify changes persist after refresh

3. **Avatar upload:**
   - In ProfileEditModal, click avatar area
   - Select an image file
   - Crop interface appears with 1:1 aspect ratio
   - Crop and upload — verify avatar appears in profile
   - Verify avatar shows in ChatMessage for user messages

4. **Chat integration:**
   - Open a PDF and send a message in chat
   - User messages should show @username (not "You")
   - User messages should show avatar image (not generic icon)
   - AI messages should still show "Lumen" with Lumen logo

5. **Sign out and back in:**
   - Sign out — verify profile state clears
   - Sign back in — verify profile loads correctly, no username claim modal (already claimed)
  </action>
  <verify>All 5 verification flows pass without errors</verify>
  <done>Complete profile system verified: username claim, profile editing, avatar upload, chat integration, and session persistence all working</done>
</task>

</tasks>

<verification>
1. All profile components exist and compile: `cd frontend && npx tsc --noEmit`
2. UsernameClaimModal auto-opens for new users (username_claimed = false)
3. ProfileEditModal accessible from AuthButton for logged-in users
4. AvatarCropUpload produces 400x400 JPEG and uploads to Supabase Storage
5. ChatMessage shows @username and avatar for authenticated users
6. Profile persists across sessions (stored in Supabase, fetched on login)
</verification>

<success_criteria>
- New user must claim a unique @username on first login (PROF-01)
- User can upload, crop, and save a profile image (PROF-02)
- User can edit bio (PROF-03), institution (PROF-04), and research interests (PROF-05)
- Profile changes save to Supabase and persist across sessions
- User sees their @username in chat interface instead of "You"
- All 5 phase success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/06-profile-system/06-02-SUMMARY.md`
</output>
