---
phase: 01-core-ux-fixes
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - frontend/src/components/pdf-viewer/HighlightContainer.tsx
  - frontend/src/components/pdf-viewer/HighlightPopup.tsx
autonomous: true

must_haves:
  truths:
    - "Note popups appear near their associated highlight, not at top-left or under the tab bar"
    - "Popup position recalculates when reopened after scrolling"
    - "All highlights show Open Notes button in hover popup (not just legacy note highlights)"
  artifacts:
    - path: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      provides: "Portal-based NotePopup with correct positioning for all highlights"
      contains: "handleOpenNotes"
    - path: "frontend/src/components/pdf-viewer/HighlightPopup.tsx"
      provides: "Open Notes button available for all highlights"
      contains: "onOpenNotes"
  key_links:
    - from: "frontend/src/components/pdf-viewer/HighlightPopup.tsx"
      to: "HighlightContainer.handleOpenNotes"
      via: "onOpenNotes callback"
      pattern: "onOpenNotes"
    - from: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      to: "document.body portal"
      via: "createPortal with fixed positioning"
      pattern: "createPortal.*document\\.body"
---

<objective>
Ensure note popups appear correctly positioned near their highlights and that all highlights (not just legacy 'note' type) provide access to the notes panel.

Purpose: Currently "Open Notes" only appears for highlights with `color: 'note'`. After Plan 01 retires the 'note' color concept, the popup UI needs updating so any highlight can show its notes panel. Additionally, popup position must recalculate on reopen (POP-04), which is already implemented but needs verification after Plan 01 changes.

Output: Updated HighlightPopup and HighlightContainer with universal notes access and verified positioning.
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-ux-fixes/01-RESEARCH.md
@.planning/phases/01-core-ux-fixes/01-01-SUMMARY.md

@frontend/src/components/pdf-viewer/HighlightContainer.tsx
@frontend/src/components/pdf-viewer/HighlightPopup.tsx
@frontend/src/components/pdf-viewer/NotePopup.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update HighlightPopup to show Open Notes for all highlights</name>
  <files>
    frontend/src/components/pdf-viewer/HighlightPopup.tsx
    frontend/src/components/pdf-viewer/HighlightContainer.tsx
  </files>
  <action>
**In HighlightPopup.tsx:**

1. Remove the `isNote` prop from the interface entirely. After Plan 01, the concept of "note" as a color category is retired. The popup behavior should not depend on highlight color.

2. Add a `hasNotes` boolean prop to the interface: `hasNotes: boolean`. This replaces the `isNote` check for controlling UI.

3. Replace the `isNote` condition for the "Open notes" button (currently `{isNote && onOpenNotes && (...)}`) with `{onOpenNotes && (...)}`. The "Open notes" button should appear for ALL highlights when `onOpenNotes` is provided. This lets users add notes to any highlight.

4. Update the "Open notes" button label:
   - If `hasNotes` is true: "Open notes"
   - If `hasNotes` is false: "Add note"
   This gives clear UX feedback about what will happen.

5. Update the delete button text: Replace `{isNote ? 'Remove note' : 'Remove highlight'}` with just `'Remove highlight'` since all highlights are now equal.

6. Remove the `note` prop and its rendering (`{note && <p>...`). Notes are now viewed in the NotePopup, not inline in HighlightPopup. This keeps HighlightPopup lightweight (actions only) and NotePopup as the full notes interface.

**In HighlightContainer.tsx:**

1. Update the `tip` construction to match the new HighlightPopup props:
   - Remove `note={...}` prop
   - Remove `isNote={isNote}` prop
   - Add `hasNotes={hasNotes}` prop (using the `hasNotes` variable from Plan 01)
   - Pass `onOpenNotes={handleOpenNotes}` unconditionally (no `isNote` conditional)

2. Verify the portal-based NotePopup positioning is still correct after Plan 01 changes. The `handleOpenNotes` callback should still call `getBoundingClientRect()` on the highlight ref. If Plan 01 changed the ref structure, fix accordingly.

3. Ensure `notePopupOpen` state and the portal rendering remain intact. The NotePopup should render via `createPortal` to `document.body` with `position: fixed`, `zIndex: 9999`, and the `translate(-50%, ...)` transform.
  </action>
  <verify>
1. `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit` — no TypeScript errors
2. Grep for `isNote` in HighlightPopup.tsx — should NOT exist
3. Grep for `hasNotes` in HighlightPopup.tsx — should exist as prop
4. Grep for `onOpenNotes={handleOpenNotes}` in HighlightContainer.tsx — should NOT have `isNote ?` conditional
  </verify>
  <done>
- HighlightPopup shows "Open notes" / "Add note" button for ALL highlights
- HighlightPopup no longer depends on `isNote` concept
- NotePopup portal positioning verified correct (near highlight, not top-left)
- Popup position recalculates on each open via getBoundingClientRect()
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit`
2. No `isNote` references in HighlightPopup.tsx
3. `onOpenNotes` passed unconditionally in HighlightContainer.tsx
4. NotePopup portals to document.body with fixed positioning
5. getBoundingClientRect() called inside handleOpenNotes callback (not at render time)
</verification>

<success_criteria>
- All highlights show "Open notes" or "Add note" in their hover popup
- Clicking "Open notes" / "Add note" opens NotePopup near the highlight
- NotePopup appears above or below the highlight (flips if near top edge)
- Reopening a popup after scrolling shows it at the correct position
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-ux-fixes/01-02-SUMMARY.md`
</output>
