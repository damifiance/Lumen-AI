---
phase: 01-core-ux-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/pdf-viewer/PdfViewer.tsx
  - frontend/src/components/pdf-viewer/SelectionTip.tsx
  - frontend/src/components/pdf-viewer/HighlightContainer.tsx
  - frontend/src/stores/highlightStore.ts
autonomous: true

must_haves:
  truths:
    - "Asking AI about an existing colored highlight keeps its original color"
    - "Asking AI from a new text selection uses the current palette color, not hardcoded yellow"
    - "Highlights with any notes (AI or user) show a dotted underline visual marker"
    - "Highlights without notes show no dotted underline"
  artifacts:
    - path: "frontend/src/components/pdf-viewer/PdfViewer.tsx"
      provides: "Color-preserving handleAskAI that accepts selectedColor parameter"
      contains: "selectedColor"
    - path: "frontend/src/components/pdf-viewer/SelectionTip.tsx"
      provides: "SelectionTip passes selected palette color to onAskAI"
      contains: "selectedColor"
    - path: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      provides: "Dotted underline style applied when highlight has notes"
      contains: "dotted"
    - path: "frontend/src/stores/highlightStore.ts"
      provides: "addNoteToHighlight preserves original color instead of forcing note"
  key_links:
    - from: "frontend/src/components/pdf-viewer/SelectionTip.tsx"
      to: "PdfViewer.handleAskAI"
      via: "onAskAI callback with selectedColor parameter"
      pattern: "onAskAI.*selectedColor"
    - from: "frontend/src/components/pdf-viewer/HighlightContainer.tsx"
      to: "TextHighlight style prop"
      via: "hasNotes conditional style"
      pattern: "hasNotes.*dotted"
---

<objective>
Fix highlight color preservation when using AI features and add dotted underline visual markers for highlights with notes.

Purpose: Users lose their color-coded organization when asking AI about highlights (color overwrites to yellow). Users also cannot distinguish which highlights have notes attached. These fixes restore highlight integrity and add visual feedback.

Output: Modified PdfViewer, SelectionTip, HighlightContainer, and highlightStore with color preservation logic and dotted underline styling.
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-ux-fixes/01-RESEARCH.md

@frontend/src/components/pdf-viewer/PdfViewer.tsx
@frontend/src/components/pdf-viewer/SelectionTip.tsx
@frontend/src/components/pdf-viewer/HighlightContainer.tsx
@frontend/src/components/pdf-viewer/HighlightPopup.tsx
@frontend/src/stores/highlightStore.ts
@frontend/src/types/highlight.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preserve highlight color on AI ask and use palette color for new selections</name>
  <files>
    frontend/src/components/pdf-viewer/PdfViewer.tsx
    frontend/src/components/pdf-viewer/SelectionTip.tsx
    frontend/src/stores/highlightStore.ts
  </files>
  <action>
**In PdfViewer.tsx:**

1. Change `handleAskAI` signature to accept `(question: string, selectedColor?: string)`.
2. Replace the hardcoded `color: 'note'` with `color: selectedColor || '#FDE68A'` (default to yellow if no color provided). This ensures new selections from SelectionTip get the user's chosen palette color.
3. The `handleHighlightAskAI` callback (used from HighlightPopup for existing highlights) already does NOT create a new highlight — it just calls `askAboutSelection`. This is correct and should NOT be changed.
4. Update the `SelectionTip` usage to pass the new signature: `onAskAI={handleAskAI}` (no change needed since SelectionTip will pass the color).

**In SelectionTip.tsx:**

1. Change the `onAskAI` prop type from `(question: string) => void` to `(question: string, selectedColor?: string) => void`.
2. Add state `const [selectedColor, setSelectedColor] = useState(COLORS[0].color)` to track which color the user last selected (default to first palette color, yellow '#FDE68A').
3. When user clicks a color button, call `setSelectedColor(color)` in addition to `onHighlight(color)`. This way the selected color is "remembered" for the AI ask.
4. In `handleSend` for askAI mode, call `onAskAI(q, selectedColor)` to pass the palette color.
5. In the default mode UI, add a visual indicator (ring-2 or scale-110) to the currently selected color button so the user knows which color will be used.

**In highlightStore.ts:**

1. In `addNoteToHighlight`, remove the logic that overwrites `color` to `'note'`. Currently lines 64-66 check `if (highlight.color !== 'note') { updateData.color = 'note'; }`. Remove this conditional entirely — notes should be added to highlights WITHOUT changing their color. The `updateData` object should only contain `{ comment: updated }`, never a color change.

**Important:** Do NOT use the string `'note'` as a color value in any new code paths. The concept of "note" as a color is being retired — highlights keep their original user-selected color regardless of whether they have notes attached.
  </action>
  <verify>
1. `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit` — no TypeScript errors
2. Grep for `color: 'note'` in PdfViewer.tsx — should appear only in `handleNote` (which is for explicit note creation, separate from AI ask)
3. Grep for `selectedColor` in SelectionTip.tsx — should appear in state and handleSend
  </verify>
  <done>
- `handleAskAI` in PdfViewer.tsx uses `selectedColor` parameter instead of hardcoded `'note'`
- SelectionTip tracks and passes palette color to onAskAI
- `addNoteToHighlight` in highlightStore no longer overwrites color to `'note'`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dotted underline visual marker for highlights with notes</name>
  <files>
    frontend/src/components/pdf-viewer/HighlightContainer.tsx
  </files>
  <action>
**In HighlightContainer.tsx:**

1. Add a `hasNotes` check: `const hasNotes = comment.trim().length > 0 && comment !== '[]';`. The `comment` field is a JSON array of NoteEntry objects. Empty comments are either `''` or `'[]'`. Check both.

2. Since `color: 'note'` is being retired (Task 1), update the color logic:
   - Remove the `isNote` variable (`const isNote = highlightColor === 'note';`).
   - For background color, handle the legacy `'note'` value: `const bgColor = highlightColor === 'note' ? '#FDE68A' : highlightColor;`
   - This ensures backward compatibility with existing highlights that still have `color: 'note'` in the database.

3. Update the `TextHighlight` style to always use `bgColor` and conditionally add dotted underline:
```typescript
style={{
  background: bgColor,
  opacity: 0.4,
  ...(hasNotes && {
    borderBottom: '2px dotted rgba(0, 0, 0, 0.35)',
  })
}}
```
NOTE: Use `borderBottom` instead of `textDecoration` because TextHighlight renders overlay divs on top of text, not inline text elements. `text-decoration` only works on inline text content. The overlay divs need `border-bottom` for visible dotted underlines.

4. Update the HighlightPopup `tip` to remove the `isNote` prop dependency. Since we're no longer distinguishing by color value, change the tip:
   - Pass `note={comment}` to HighlightPopup for ALL highlights (not just when `isNote` is true).
   - Pass `onOpenNotes={hasNotes || highlightColor === 'note' ? handleOpenNotes : undefined}` — allow opening notes for any highlight that has notes OR that was a legacy 'note' highlight.
   - Actually simpler: pass `onOpenNotes={handleOpenNotes}` unconditionally for ALL highlights. Users should be able to open the notes panel from any highlight to add notes.

5. Update the NotePopup portal rendering: Remove the `isNote` condition from the open notes button. The NotePopup should be openable from ANY highlight, not just those with `color: 'note'`.
  </action>
  <verify>
1. `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit` — no TypeScript errors
2. Grep for `hasNotes` in HighlightContainer.tsx — should exist
3. Grep for `dotted` in HighlightContainer.tsx — should exist in style
4. Grep for `isNote` in HighlightContainer.tsx — should NOT exist (removed)
  </verify>
  <done>
- Highlights with notes display a dotted underline (via borderBottom on overlay div)
- Highlights without notes have no dotted underline
- All highlights can open the notes panel (not just legacy 'note' highlights)
- Legacy `color: 'note'` highlights render with yellow background for backward compatibility
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd /Users/damifiance/workspace/AI-paper-reader/frontend && npx tsc --noEmit`
2. No hardcoded `color: 'note'` in handleAskAI flow (PdfViewer.tsx)
3. SelectionTip passes selectedColor to onAskAI
4. HighlightContainer renders dotted underline when hasNotes is true
5. highlightStore.addNoteToHighlight does not overwrite color
</verification>

<success_criteria>
- Asking AI about an existing highlight preserves its original color
- Asking AI from SelectionTip uses the currently selected palette color
- Highlights with notes show dotted underline border
- Highlights without notes show no dotted underline
- All existing highlights continue to render correctly (backward compatibility with 'note' color value)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-ux-fixes/01-01-SUMMARY.md`
</output>
