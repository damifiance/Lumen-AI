---
phase: 07-security-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - electron/main.js
  - electron/preload.js
  - frontend/src/stores/authStore.ts
  - frontend/src/components/auth/AccountDeleteSection.tsx
  - frontend/src/components/profile/ProfileEditModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can delete their account from profile settings"
    - "Account deletion requires password confirmation to prevent accidents"
    - "Deletion removes avatar from Storage, profile from DB, and auth record"
    - "After deletion, user is signed out and returned to app"
    - "App works fully offline with Ollama when no auth configured"
  artifacts:
    - path: "frontend/src/components/auth/AccountDeleteSection.tsx"
      provides: "Danger zone UI with password confirmation and delete button"
      contains: "deleteAccount"
    - path: "electron/main.js"
      provides: "IPC handler for account deletion using Supabase admin API"
      contains: "delete-user-account"
    - path: "electron/preload.js"
      provides: "deleteUserAccount bridge method"
      contains: "delete-user-account"
  key_links:
    - from: "frontend/src/components/auth/AccountDeleteSection.tsx"
      to: "electron/preload.js deleteUserAccount"
      via: "window.electron.deleteUserAccount IPC"
      pattern: "deleteUserAccount"
    - from: "electron/main.js delete-user-account handler"
      to: "Supabase admin API"
      via: "supabaseAdmin.auth.admin.deleteUser"
      pattern: "admin\\.deleteUser"
    - from: "AccountDeleteSection.tsx"
      to: "ProfileEditModal.tsx"
      via: "Rendered inside ProfileEditModal as danger zone section"
      pattern: "AccountDeleteSection"
---

<objective>
Implement account deletion with GDPR-compliant cascade deletion and integrate into profile UI.

Purpose: SEC-03 requirement — users can permanently delete their account and all associated data. This requires admin API access (service_role key) in the Electron main process for deleting auth records, with cascade deletion of Storage objects and profile data.

Output: Account deletion IPC handler, AccountDeleteSection UI component with password confirmation, integrated into ProfileEditModal.
</objective>

<execution_context>
@/Users/damifiance/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damifiance/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-polish/07-RESEARCH.md
@.planning/phases/07-security-polish/07-01-SUMMARY.md
@electron/main.js
@electron/preload.js
@frontend/src/stores/authStore.ts
@frontend/src/stores/profileStore.ts
@frontend/src/components/profile/ProfileEditModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add account deletion IPC handler and auth store method</name>
  <files>
    electron/main.js
    electron/preload.js
    frontend/src/stores/authStore.ts
  </files>
  <action>
**electron/main.js — Add Supabase admin client and deletion IPC handler:**

1. At top of file, add `createClient` import (Supabase JS):
   ```javascript
   const { createClient } = require('@supabase/supabase-js');
   ```

2. Create admin client ONLY if service_role key is available. Add after imports:
   ```javascript
   // Admin client for privileged operations (account deletion)
   // CRITICAL: service_role key must NEVER be exposed to renderer process
   let supabaseAdmin = null;
   const supabaseUrl = process.env.VITE_SUPABASE_URL;
   const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
   if (supabaseUrl && serviceRoleKey) {
     supabaseAdmin = createClient(supabaseUrl, serviceRoleKey, {
       auth: { autoRefreshToken: false, persistSession: false }
     });
   }
   ```

3. Add IPC handler inside `app.whenReady().then(async () => { ... })`, alongside other ipcMain.handle calls:
   ```javascript
   ipcMain.handle('delete-user-account', async (_event, userId) => {
     if (!supabaseAdmin) {
       return { success: false, error: 'Admin API not configured (missing SUPABASE_SERVICE_ROLE_KEY)' };
     }
     try {
       // 1. Delete avatar from Storage (prevent orphaned files)
       const { data: profile } = await supabaseAdmin
         .from('profiles')
         .select('avatar_url')
         .eq('id', userId)
         .single();

       if (profile?.avatar_url) {
         const avatarPath = profile.avatar_url.split('/').slice(-2).join('/');
         await supabaseAdmin.storage.from('avatars').remove([avatarPath]);
       }

       // 2. Delete profile record
       await supabaseAdmin.from('profiles').delete().eq('id', userId);

       // 3. Delete auth.users record (hard delete)
       const { error } = await supabaseAdmin.auth.admin.deleteUser(userId, {
         shouldSoftDelete: false,
       });

       if (error) throw error;
       return { success: true };
     } catch (err) {
       console.error('Account deletion error:', err);
       return { success: false, error: err.message || 'Deletion failed' };
     }
   });
   ```

**electron/preload.js — Add deleteUserAccount bridge:**

Add to the contextBridge object:
```javascript
deleteUserAccount: (userId) => ipcRenderer.invoke('delete-user-account', userId),
```

**frontend/src/stores/authStore.ts — Add deleteAccount method:**

1. Add to AuthState interface:
   ```typescript
   deleteAccount: (password: string) => Promise<{ error?: string }>;
   ```

2. Implement:
   ```typescript
   deleteAccount: async (password: string) => {
     const { user } = get();
     if (!user?.email) return { error: 'No user logged in' };

     set({ isLoading: true, error: null });
     try {
       // Re-authenticate to confirm password
       const { error: authError } = await supabase.auth.signInWithPassword({
         email: user.email,
         password,
       });
       if (authError) {
         set({ isLoading: false });
         return { error: 'Incorrect password' };
       }

       // Call Electron main process to delete (requires service_role key)
       if (window.electron?.deleteUserAccount) {
         const result = await window.electron.deleteUserAccount(user.id);
         if (!result.success) {
           set({ isLoading: false });
           return { error: result.error || 'Deletion failed' };
         }
       } else {
         // Web fallback — can't delete without admin API
         set({ isLoading: false });
         return { error: 'Account deletion requires the desktop app' };
       }

       // Sign out locally
       await supabase.auth.signOut();
       set({ user: null, session: null, isLoading: false });
       return {};
     } catch (err) {
       const translated = translateAuthError(err);
       set({ error: translated, isLoading: false });
       return { error: translated };
     }
   },
   ```

Also update the `window.electron` TypeScript declaration (likely in a `global.d.ts` or `vite-env.d.ts`) to include `deleteUserAccount: (userId: string) => Promise<{ success: boolean; error?: string }>` and `onAuthDeepLink` from Plan 01.
  </action>
  <verify>
    - `grep "delete-user-account" electron/main.js electron/preload.js` shows handler and bridge
    - `grep "deleteAccount" frontend/src/stores/authStore.ts` shows method
    - `grep "supabaseAdmin" electron/main.js` shows admin client creation
    - `grep "shouldSoftDelete: false" electron/main.js` confirms hard delete
    - TypeScript compilation passes: `npx tsc --noEmit` (from frontend/)
  </verify>
  <done>
    - Electron main process has admin Supabase client (only if service_role key available)
    - IPC handler deletes: avatar from Storage, profile from DB, auth record (in order)
    - preload.js exposes deleteUserAccount bridge
    - authStore deleteAccount method re-authenticates with password, then calls IPC
    - Graceful fallback when admin API not configured or running in web mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Create account deletion UI and integrate into profile</name>
  <files>
    frontend/src/components/auth/AccountDeleteSection.tsx
    frontend/src/components/profile/ProfileEditModal.tsx
  </files>
  <action>
**AccountDeleteSection.tsx — New component (NOT a modal, a section within ProfileEditModal):**

Structure:
- Danger zone section with red border styling
- Two states: collapsed (just "Delete account" button) and expanded (confirmation form)
- Expanded state shows:
  - Warning text: "This will permanently delete your account, profile, avatar, and all associated data. This action cannot be undone."
  - Password input for confirmation
  - "Delete my account" button (red, disabled while processing) + "Cancel" button
- Calls `useAuthStore().deleteAccount(password)`
- On success: user is already signed out by the store method. Clear profile store too.
- On error: show error message inline
- Uses lucide icons: AlertTriangle, Loader2

Styling (matching existing Tailwind patterns):
```tsx
// Outer container
<div className="border-t border-red-200 pt-5 mt-6">
  <h3 className="text-sm font-semibold text-red-600 mb-1">Danger Zone</h3>
  <p className="text-xs text-gray-500 mb-3">
    Once deleted, your account and all data cannot be recovered.
  </p>
  // Button / expanded form
</div>
```

Confirmation button styling:
```
className="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-xl hover:bg-red-700 cursor-pointer transition-all disabled:opacity-50 disabled:cursor-not-allowed"
```

**ProfileEditModal.tsx — Add AccountDeleteSection:**

Import and render `<AccountDeleteSection />` at the bottom of the modal content, below the existing profile edit fields. This is the natural place for account settings — users edit profile and see account actions in the same modal.

If the modal is structured with save/cancel buttons at bottom, place AccountDeleteSection ABOVE those buttons but visually separated with `border-t border-red-200`.

Also import `useProfileStore` and call `clearProfile()` after successful deletion to clean up profile state.
  </action>
  <verify>
    - AccountDeleteSection.tsx exists with danger zone UI
    - `grep "AccountDeleteSection" frontend/src/components/profile/ProfileEditModal.tsx` shows integration
    - `grep "deleteAccount" frontend/src/components/auth/AccountDeleteSection.tsx` shows store method call
    - `grep "clearProfile" frontend/src/components/auth/AccountDeleteSection.tsx` or ProfileEditModal shows cleanup
    - TypeScript compilation passes: `npx tsc --noEmit` (from frontend/)
  </verify>
  <done>
    - AccountDeleteSection renders danger zone with password confirmation
    - Integrated into ProfileEditModal below profile fields
    - Deletion flow: expand -> enter password -> confirm -> account deleted -> signed out
    - Profile store cleared on deletion
    - Error handling with inline error messages
    - Consistent styling with existing auth components
  </done>
</task>

</tasks>

<verification>
1. Account deletion flow: open profile -> scroll to danger zone -> click delete -> enter password -> confirm -> signed out
2. Cascade deletion order: avatar (Storage) -> profile (DB) -> auth record
3. Password re-entry prevents accidental deletion
4. Graceful error when service_role key not configured
5. Profile state cleaned up after deletion
6. TypeScript compiles without errors
</verification>

<success_criteria>
- User can delete account from ProfileEditModal danger zone
- Deletion requires password confirmation
- Cascade deletion removes avatar, profile, and auth record
- User is signed out after deletion
- Admin API gracefully handles missing service_role key
- All UI consistent with existing auth component styling
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-polish/07-02-SUMMARY.md`
</output>
