<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile — Lumen AI</title>
  <meta name="description" content="Edit your Lumen AI profile — avatar, username, bio, and more." />
  <link rel="icon" href="https://raw.githubusercontent.com/damifiance/Lumen-AI/master/electron/build/icon.png" type="image/png" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="shared-auth.js"></script>
</head>
<body>

  <!-- Nav -->
  <nav class="nav">
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="features.html">Features</a>
      <a href="index.html#download">Download</a>
    </div>
    <a href="index.html" class="nav-logo">
      <img
        src="https://raw.githubusercontent.com/damifiance/Lumen-AI/master/electron/build/icon.png"
        alt="Lumen AI"
      />
      Lumen AI
    </a>
    <div class="nav-right">
      <a href="index.html#download" class="btn-nav btn-nav-amber">Download</a>
      <a href="auth.html" class="btn-nav btn-nav-amber-dark" id="nav-signin-link">Sign In</a>
    </div>
  </nav>

  <!-- Cover Banner -->
  <div class="profile-cover"></div>

  <!-- Loading state (centered) -->
  <div id="profile-loading" style="text-align:center; padding:80px 0;">
    <p style="color:var(--text-muted);">Loading profile...</p>
  </div>

  <!-- Profile Content (hidden until loaded) -->
  <div class="profile-page" id="profile-content" style="display:none;">
    <div class="profile-container">

      <!-- Header: avatar + name -->
      <div class="profile-header">
        <div class="profile-avatar-preview" id="avatar-preview">
          <span class="avatar-placeholder" id="avatar-placeholder">U</span>
          <label class="profile-avatar-upload-overlay">
            <span>Edit</span>
            <input type="file" id="avatar-input" accept="image/*" />
          </label>
        </div>
        <div class="profile-header-info">
          <h2 id="profile-heading">Edit Profile</h2>
          <p id="profile-email"></p>
        </div>
      </div>

      <!-- Save feedback (between header and cards) -->
      <div class="save-feedback" id="save-feedback" style="margin-bottom:12px;"></div>

      <!-- Form -->
      <form id="profile-form" onsubmit="handleSaveProfile(event)">

        <!-- Card: Identity -->
        <div class="profile-card">
          <div class="profile-card-title">Identity</div>
          <div class="profile-form">
            <div class="profile-row">
              <div class="profile-field">
                <label for="profile-username">Username</label>
                <div class="username-wrapper">
                  <input type="text" id="profile-username" placeholder="your_username" pattern="[a-z0-9_]{3,30}" title="3-30 characters: lowercase letters, numbers, underscores" required />
                  <span class="username-status" id="username-status"></span>
                </div>
              </div>
              <div class="profile-field">
                <label for="profile-display-name">Display Name</label>
                <input type="text" id="profile-display-name" placeholder="Your Name" maxlength="100" />
              </div>
            </div>
            <div class="profile-field">
              <label for="profile-bio">Bio</label>
              <textarea id="profile-bio" placeholder="Tell us about yourself..." maxlength="500"></textarea>
            </div>
          </div>
        </div>

        <!-- Card: Research -->
        <div class="profile-card">
          <div class="profile-card-title">Research</div>
          <div class="profile-form">
            <div class="profile-field">
              <label for="profile-institution">Institution</label>
              <input type="text" id="profile-institution" placeholder="University or organization" maxlength="200" />
            </div>
            <div class="profile-field">
              <label for="profile-interests-input">Research Interests</label>
              <input type="text" id="profile-interests-input" placeholder="Type and press Enter to add" maxlength="100" />
              <div class="interests-tags" id="interests-tags"></div>
            </div>
          </div>
        </div>

        <!-- Save -->
        <div class="profile-save-row">
          <button type="submit" class="auth-btn auth-btn-primary" id="save-btn">
            <span class="auth-btn-text">Save Changes</span>
            <span class="auth-btn-loading" style="display:none;">Saving...</span>
          </button>
          <span class="save-feedback" id="save-feedback-inline"></span>
        </div>

      </form>

      <!-- Card: Account -->
      <div class="profile-card" style="margin-top:16px;">
        <div class="profile-card-title">Account</div>
        <div class="profile-footer-actions">
          <button class="auth-btn auth-btn-primary" onclick="openApp()">Open Lumen AI</button>
          <button class="auth-btn auth-btn-secondary" onclick="handleSignOut()">Sign Out</button>
        </div>
      </div>

      <!-- Card: Danger Zone -->
      <div class="profile-card danger-zone" style="margin-top:16px;">
        <div class="profile-card-title">Danger Zone</div>
        <p class="danger-zone-desc">
          Permanently delete your account, profile, and all associated data. This action cannot be undone.
        </p>
        <button class="danger-zone-btn" id="delete-account-btn" onclick="showDeleteConfirm()">
          Delete Account
        </button>
        <div class="delete-confirm-overlay" id="delete-confirm">
          <p>To confirm, type <strong>delete my account</strong> below:</p>
          <input type="text" id="delete-confirm-input" placeholder="delete my account" autocomplete="off" />
          <div id="delete-feedback" class="save-feedback" style="margin-bottom:8px;"></div>
          <div class="delete-confirm-actions">
            <button class="cancel-btn" onclick="hideDeleteConfirm()">Cancel</button>
            <button class="danger-zone-btn" id="confirm-delete-btn" onclick="handleDeleteAccount()" disabled>
              Permanently Delete
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-links">
      <a href="index.html">Home</a>
      <a href="https://github.com/damifiance/Lumen-AI">GitHub</a>
      <a href="https://github.com/damifiance/Lumen-AI/releases">Releases</a>
    </div>
    <p class="copyright">
      <span class="sun-dot"></span>
      Lumen AI &mdash; by JaeHyung (Benjamin) Park
    </p>
  </footer>

  <script>
    const APP_REDIRECT = 'lumenai://auth/session';
    let currentProfile = null;
    let currentUserId = null;
    let originalUsername = null;
    let usernameCheckTimeout = null;
    let researchInterests = [];
    const isSetup = new URLSearchParams(window.location.search).get('setup') === '1';

    // =============================================
    // Init
    // =============================================
    (async function init() {
      const { data: { session } } = await window.sb.auth.getSession();
      if (!session) {
        window.location.href = 'auth.html?redirect=profile';
        return;
      }

      currentUserId = session.user.id;
      document.getElementById('profile-email').textContent = session.user.email || '';

      // Fetch or create profile
      let { data: profile, error } = await window.sb
        .from('profiles')
        .select('*')
        .eq('id', currentUserId)
        .single();

      if (error && error.code === 'PGRST116') {
        const email = session.user.email || '';
        const baseName = email.split('@')[0] || 'user';
        const sanitized = baseName.toLowerCase().replace(/[^a-z0-9_]/g, '_').slice(0, 26);
        const username = sanitized.length < 3 ? 'user_' + sanitized : sanitized;

        const { data: newProfile, error: insertError } = await window.sb
          .from('profiles')
          .insert({ id: currentUserId, username, username_claimed: false })
          .select()
          .single();

        if (insertError) {
          document.getElementById('profile-loading').innerHTML =
            '<p style="color:#dc2626;">Failed to create profile. Please try again.</p>';
          return;
        }
        profile = newProfile;
      } else if (error) {
        document.getElementById('profile-loading').innerHTML =
          '<p style="color:#dc2626;">Failed to load profile. Please try again.</p>';
        return;
      }

      currentProfile = profile;
      originalUsername = profile.username;
      researchInterests = profile.research_interests || [];

      if (isSetup) {
        document.getElementById('profile-heading').textContent = 'Set Up Your Profile';
      }

      // Populate form
      document.getElementById('profile-username').value = profile.username || '';
      document.getElementById('profile-display-name').value = profile.display_name || '';
      document.getElementById('profile-bio').value = profile.bio || '';
      document.getElementById('profile-institution').value = profile.institution || '';
      renderInterests();
      renderAvatar(profile.avatar_url, session.user.email);

      // Show content
      document.getElementById('profile-loading').style.display = 'none';
      document.getElementById('profile-content').style.display = 'flex';
    })();

    // =============================================
    // Avatar
    // =============================================
    function renderAvatar(avatarUrl, email) {
      const preview = document.getElementById('avatar-preview');
      // Keep the upload overlay label
      const overlay = preview.querySelector('.profile-avatar-upload-overlay');
      if (avatarUrl) {
        // Remove placeholder, add img before overlay
        const existing = preview.querySelector('img');
        const placeholder = preview.querySelector('.avatar-placeholder');
        if (placeholder) placeholder.remove();
        if (existing) existing.remove();
        const img = document.createElement('img');
        img.src = avatarUrl;
        img.alt = 'Avatar';
        preview.insertBefore(img, overlay);
      } else {
        const initial = (email || 'U')[0].toUpperCase();
        const placeholder = preview.querySelector('.avatar-placeholder');
        if (placeholder) placeholder.textContent = initial;
      }
    }

    document.getElementById('avatar-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) {
        showFeedback('Image must be under 2MB', true);
        return;
      }

      showFeedback('Uploading...', false);

      try {
        const blob = await cropToSquare(file, 400);

        if (currentProfile.avatar_url) {
          const oldPath = currentProfile.avatar_url.split('/').slice(-2).join('/');
          await window.sb.storage.from('avatars').remove([oldPath]);
        }

        const fileName = 'avatar-' + Date.now() + '.jpg';
        const filePath = currentUserId + '/' + fileName;
        const { error: uploadError } = await window.sb.storage
          .from('avatars')
          .upload(filePath, blob, { contentType: 'image/jpeg', upsert: false });
        if (uploadError) throw uploadError;

        const { data } = window.sb.storage.from('avatars').getPublicUrl(filePath);
        const newUrl = data.publicUrl;

        await window.sb
          .from('profiles')
          .update({ avatar_url: newUrl, updated_at: new Date().toISOString() })
          .eq('id', currentUserId);

        currentProfile.avatar_url = newUrl;
        renderAvatar(newUrl);
        showFeedback('Avatar updated!', false);
      } catch (err) {
        showFeedback('Upload failed: ' + (err.message || 'Unknown error'), true);
      }

      e.target.value = '';
    });

    function cropToSquare(file, size) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          const min = Math.min(img.width, img.height);
          const sx = (img.width - min) / 2;
          const sy = (img.height - min) / 2;
          ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
          canvas.toBlob(
            (blob) => (blob ? resolve(blob) : reject(new Error('Canvas to blob failed'))),
            'image/jpeg', 0.85
          );
        };
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = URL.createObjectURL(file);
      });
    }

    // =============================================
    // Username availability check
    // =============================================
    document.getElementById('profile-username').addEventListener('input', (e) => {
      const val = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
      e.target.value = val;

      const statusEl = document.getElementById('username-status');
      if (val === originalUsername) {
        statusEl.textContent = '';
        statusEl.className = 'username-status';
        return;
      }
      if (val.length < 3) {
        statusEl.textContent = 'Too short';
        statusEl.className = 'username-status taken';
        return;
      }

      statusEl.textContent = '...';
      statusEl.className = 'username-status checking';

      clearTimeout(usernameCheckTimeout);
      usernameCheckTimeout = setTimeout(async () => {
        const { data } = await window.sb
          .from('profiles')
          .select('id')
          .eq('username', val)
          .neq('id', currentUserId)
          .single();

        if (data) {
          statusEl.textContent = 'Taken';
          statusEl.className = 'username-status taken';
        } else {
          statusEl.textContent = 'Available';
          statusEl.className = 'username-status available';
        }
      }, 400);
    });

    // =============================================
    // Research Interests
    // =============================================
    document.getElementById('profile-interests-input').addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      e.preventDefault();
      const val = e.target.value.trim();
      if (val && researchInterests.length < 10 && !researchInterests.includes(val)) {
        researchInterests.push(val);
        renderInterests();
      }
      e.target.value = '';
    });

    function renderInterests() {
      const container = document.getElementById('interests-tags');
      container.innerHTML = researchInterests.map((tag, i) =>
        '<span class="interest-tag">' + escapeHtml(tag) +
        '<button type="button" onclick="removeInterest(' + i + ')">&times;</button></span>'
      ).join('');
    }

    function removeInterest(index) {
      researchInterests.splice(index, 1);
      renderInterests();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // =============================================
    // Save Profile
    // =============================================
    async function handleSaveProfile(e) {
      e.preventDefault();

      const username = document.getElementById('profile-username').value;
      const statusEl = document.getElementById('username-status');

      if (statusEl.classList.contains('taken')) {
        showFeedback('Username is not available', true);
        return;
      }

      const btn = document.getElementById('save-btn');
      btn.querySelector('.auth-btn-text').style.display = 'none';
      btn.querySelector('.auth-btn-loading').style.display = 'inline';
      btn.disabled = true;

      try {
        const updates = {
          username,
          username_claimed: true,
          display_name: document.getElementById('profile-display-name').value || null,
          bio: document.getElementById('profile-bio').value || null,
          institution: document.getElementById('profile-institution').value || null,
          research_interests: researchInterests,
          updated_at: new Date().toISOString(),
        };

        const { error } = await window.sb
          .from('profiles')
          .update(updates)
          .eq('id', currentUserId);

        if (error) throw error;

        originalUsername = username;
        statusEl.textContent = '';
        currentProfile = { ...currentProfile, ...updates };
        showFeedback('Profile saved!', false);
      } catch (err) {
        showFeedback('Save failed: ' + (err.message || 'Unknown error'), true);
      }

      btn.querySelector('.auth-btn-text').style.display = 'inline';
      btn.querySelector('.auth-btn-loading').style.display = 'none';
      btn.disabled = false;
    }

    // =============================================
    // Helpers
    // =============================================
    function showFeedback(msg, isError) {
      const el = document.getElementById('save-feedback');
      el.textContent = msg;
      el.className = 'save-feedback ' + (isError ? 'error' : 'success');
      if (!isError) {
        setTimeout(() => { el.className = 'save-feedback'; }, 3000);
      }
    }

    function openApp() {
      window.sb.auth.getSession().then(({ data: { session } }) => {
        if (session) {
          const deepLink = APP_REDIRECT +
            '?access_token=' + encodeURIComponent(session.access_token) +
            '&refresh_token=' + encodeURIComponent(session.refresh_token);
          launchDeepLink(deepLink);
        }
      });
    }

    function launchDeepLink(url) {
      const a = document.createElement('a');
      a.href = url;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => a.remove(), 100);
    }

    async function handleSignOut() {
      await window.sb.auth.signOut();
      window.location.href = 'auth.html';
    }

    // =============================================
    // Account Deletion
    // =============================================
    function showDeleteConfirm() {
      document.getElementById('delete-confirm').classList.add('visible');
      document.getElementById('delete-account-btn').style.display = 'none';
      document.getElementById('delete-confirm-input').focus();
    }

    function hideDeleteConfirm() {
      document.getElementById('delete-confirm').classList.remove('visible');
      document.getElementById('delete-account-btn').style.display = '';
      document.getElementById('delete-confirm-input').value = '';
      document.getElementById('confirm-delete-btn').disabled = true;
      document.getElementById('delete-feedback').textContent = '';
    }

    document.getElementById('delete-confirm-input').addEventListener('input', (e) => {
      const match = e.target.value.trim().toLowerCase() === 'delete my account';
      document.getElementById('confirm-delete-btn').disabled = !match;
    });

    async function handleDeleteAccount() {
      const btn = document.getElementById('confirm-delete-btn');
      const feedback = document.getElementById('delete-feedback');
      btn.disabled = true;
      btn.textContent = 'Deleting...';
      feedback.textContent = '';

      try {
        // Call Supabase database function (SECURITY DEFINER — runs with elevated privileges)
        const { error } = await window.sb.rpc('delete_own_account');
        if (error) throw error;

        // Sign out locally and redirect
        await window.sb.auth.signOut();
        window.location.href = 'auth.html?deleted=1';
      } catch (err) {
        feedback.textContent = 'Deletion failed: ' + (err.message || 'Unknown error');
        feedback.className = 'save-feedback error';
        btn.textContent = 'Permanently Delete';
        btn.disabled = false;
      }
    }
  </script>

</body>
</html>
